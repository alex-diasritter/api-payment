<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Pagamento Pix</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<div class="container">

    <div class="header">
        <h2 id="headerTitle">Pagamento Pix</h2>
        <p id="headerSubtitle">Preencha os dados para continuar</p>
    </div>

    <form id="pixForm">
        <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required placeholder="seu@email.com">
            <div class="error" id="emailError"></div>
        </div>

        <button type="submit" id="submitBtn">Gerar Pagamento</button>
    </form>

    <div id="pixDetails" style="display: none;">
        <img id="qrCodeImage" src="" alt="QR Code Pix" class="qr-code">
        <p id="countdownTimer" class="expiration-text"></p>
        <div class="payload-container">
            <input type="text" id="pixPayload" readonly>
            <button id="copyBtn" class="copy-btn">Copiar</button>
        </div>
        <p id="multiplePayments" class="info-text"></p>
    </div>

    <p id="mensagem"></p>

</div>

<script>
    const form = document.getElementById('pixForm');
    const emailInput = document.getElementById('email');
    const submitBtn = document.getElementById('submitBtn');
    const mensagem = document.getElementById('mensagem');

    const pixDetails = document.getElementById('pixDetails');
    const headerTitle = document.getElementById('headerTitle');
    const headerSubtitle = document.getElementById('headerSubtitle');
    const qrCodeImage = document.getElementById('qrCodeImage');
    const pixPayloadInput = document.getElementById('pixPayload');
    const multiplePaymentsP = document.getElementById('multiplePayments');
    const copyBtn = document.getElementById('copyBtn');
    const countdownTimerP = document.getElementById('countdownTimer');

    let countdownInterval; // Variável para controlar o timer

    emailInput.addEventListener('input', validateEmail);

    function validateEmail() {
        const email = emailInput.value.trim();
        const error = document.getElementById('emailError');
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            error.textContent = 'Por favor, insira um email válido.';
            return false;
        }
        error.textContent = '';
        return true;
    }

    function validateForm() {
        return validateEmail();
    }

    function startCountdown(expirationDateString) {
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }

        const expirationTime = new Date(expirationDateString).getTime();

        countdownInterval = setInterval(() => {
            const now = new Date().getTime();
            const distance = expirationTime - now;

            if (distance < 0) {
                clearInterval(countdownInterval);
                countdownTimerP.textContent = "QR Code Expirado!";
                qrCodeImage.style.opacity = '0.2';
                return;
            }

            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            const formattedSeconds = seconds < 10 ? '0' + seconds : seconds;
            const formattedMinutes = minutes < 10 ? '0' + minutes : minutes;

            countdownTimerP.textContent = `Expira em: ${formattedMinutes}:${formattedSeconds}`;
        }, 1000);
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!validateForm()) {
            mensagem.textContent = 'Por favor, corrija os erros acima';
            mensagem.style.color = '#e74c3c';
            return;
        }

        submitBtn.textContent = 'Processando...';
        submitBtn.disabled = true;
        form.classList.add('loading');
        mensagem.textContent = '';

        // Objeto de dados agora envia apenas o email
        const data = { email: emailInput.value.trim() };

        try {
            const response = await fetch('/api/pix', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: `Erro ${response.status}` }));
                throw new Error(errorData.message || 'Erro ao gerar o pagamento.');
            }

            const qrCodeData = await response.json();

            headerTitle.textContent = 'Pague com Pix';
            headerSubtitle.textContent = 'Escaneie o QR Code ou copie o código';
            form.style.display = 'none';

            qrCodeImage.src = 'data:image/png;base64,' + qrCodeData.encodedImage;
            pixPayloadInput.value = qrCodeData.payload;

            startCountdown(qrCodeData.expirationDate);

            if (qrCodeData.allowsMultiplePayments) {
                multiplePaymentsP.textContent = 'Este QR Code aceita múltiplos pagamentos.';
            }

            pixDetails.style.display = 'flex';

        } catch (err) {
            console.error('Erro:', err);
            mensagem.textContent = err.message;
            mensagem.style.color = '#e74c3c';
        } finally {
            submitBtn.textContent = 'Gerar Pagamento';
            submitBtn.disabled = false;
            form.classList.remove('loading');
        }
    });

    copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(pixPayloadInput.value).then(() => {
            copyBtn.textContent = 'Copiado!';
            setTimeout(() => { copyBtn.textContent = 'Copiar'; }, 2000);
        });
    });
</script>

</body>
</html>